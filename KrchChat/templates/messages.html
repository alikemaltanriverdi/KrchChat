{% load static %}
<!DOCTYPE html>
<html>
	<head>  
		<title>KRCH Chat</title>
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
		<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
        <script src="{% static 'external/js/jquery.js' %}"></script>
		<link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.js"></script>
        <link rel="stylesheet" href="{% static 'css/messages.css' %}">
        <link rel="stylesheet" href="{% static 'external/css/style.css' %}">
        <link rel="stylesheet" href="{% static 'external/css/custom.css' %}">
        <link rel="stylesheet" href="{% static 'external/css/font-icons.css' %}">

    </head>


	<body>
        {% if user.is_authenticated %}
        <input type="hidden" id="logged-in-user" value="{{ user.id }}">
        {% endif %}
        <div class="body-overlay"></div>
        <!-- <div id="side-panel" class="dark">

            <div id="side-panel-trigger-close" class="side-panel-trigger"><a href="#"><i class="bi-x-lg"></i></a></div>
    
            <div class="side-panel-wrap">
    
                <div class="widget">
    
                    <h4>Friends</h4>
                    {% if user.is_authenticated %}
                 
                    <h4>{{ user.username }}</h4>
                    {% endif %}
                    <nav class="nav-tree mb-0">
                        <ul>
                            <li><a href="#"><i class="bi-lightning-fill"></i>Features</a>
                                <ul>
                                    <li><a href="#">Sliders</a></li>
                                    <li><a href="#">Widgets</a></li>
                                    <li><a href="#">Events</a></li>
                                    <li><a href="#">Headers</a></li>
                                </ul>
                            </li>
                            <li><a href="#"><i class="bi-card-image"></i>Portfolio</a>
                                <ul>
                                    <li><a href="#">Grid</a>
                                        <ul>
                                            <li><a href="#">3 Columns</a></li>
                                            <li><a href="#">4 Columns</a></li>
                                            <li><a href="#">5 Columns</a></li>
                                        </ul>
                                    </li>
                                    <li><a href="#">Masonry</a></li>
                                    <li><a href="#">Loading Styles</a></li>
                                    <li><a href="#">Single</a></li>
                                </ul>
                            </li>
                            <li><a href="#"><i class="bi-file-text"></i>About</a>
                                <ul>
                                    <li><a href="#">Company</a></li>
                                    <li><a href="#">Team</a></li>
                                    <li><a href="#">Services</a></li>
                                    <li><a href="#">FAQs</a></li>
                                </ul>
                            </li>
                            <li><a href="#"><i class="bi-geo-alt-fill"></i>Contact</a></li>
                        </ul>
                    </nav>
    
                </div>
    
                <div class="widget quick-contact-widget form-widget">
    
                    <h4>Quick Contact</h4>
                    <div class="form-result"></div>
                    <form id="quick-contact-form" name="quick-contact-form" action="include/form.php" method="post" class="quick-contact-form mb-0">
                        <div class="form-process">
                            <div class="css3-spinner">
                                <div class="css3-spinner-scaler"></div>
                            </div>
                        </div>
                        <input type="text" class="required form-control mb-2" id="quick-contact-form-name" name="quick-contact-form-name" value="" placeholder="Full Name">
                        <input type="text" class="required form-control email mb-2" id="quick-contact-form-email" name="quick-contact-form-email" value="" placeholder="Email Address">
                        <textarea class="required form-control mb-2 short-textarea" id="quick-contact-form-message" name="quick-contact-form-message" rows="4" cols="30" placeholder="Message"></textarea>
                        <input type="text" class="d-none" id="quick-contact-form-botcheck" name="quick-contact-form-botcheck" value="">
                        <input type="hidden" name="prefix" value="quick-contact-form-">
                        <button type="submit" id="quick-contact-form-submit" name="quick-contact-form-submit" class="button button-small button-3d m-0" value="submit">Send Email</button>
                    </form>
    
                </div>
    
            </div>
    
        </div> -->
     
        <!-- Header
		============================================= -->
		<header id="header" class="full-header ligth">
			<div id="header-wrap">
				<div class="container">
					<div class="header-row">
						<!-- Logo
						============================================= -->
						<div id="logo">
							<a href="#">
								<!-- side-panel-trigger -->
								<img class="logo-default " srcset="{% static 'assets/Krch-logos_black.png' %}" src="{% static 'assets/Krch-logos_black.png' %}" alt="Krch Logo">
								<img class="logo-dark " srcset="{% static 'assets/Krch-logos_black.png' %}" src="{% static 'assets/Krch-logos_black.png' %}" alt="Krch Logo">
							</a>
						</div><!-- #logo end -->
                               

						<div class="header-misc">
							<!-- Top Cart
							============================================= -->
							<div id="top-cart" class="header-misc-icon d-none d-sm-block">
                                
								<div id="top-cart-trigger">
                                   
                                    <div class="feature-box fbox-effect">
                                        <div class="fbox-icon">
                                            <a href="#"><i class="bi-person i-alt"></i></a>
                                        </div>
                                      
                                        
                                    </div>
                                </div>
								<div class="top-cart-content">
									<div class="top-cart-title">
										<h4>Account</h4>
                                        <span >
                                            <h3>{{ user.username }}</h3>
                                        </span>
									</div>
									<div class="top-cart-items">
										<div class="top-cart-item">
											<div class="top-cart-item-image">
												<div class="fbox-icon">
                                                    <a href="#"><i class="bi-person-fill-gear i-alt"></i></a>
                                                </div>
											</div>
											<div class="top-cart-item-desc">
												<div class="top-cart-item-desc-title">
													<a href="#">Go to Profile</a>
													<!-- <span class="top-cart-item-price d-block">$19.99</span> -->
												</div>
												<!-- <div class="top-cart-item-quantity">x 2</div> -->
											</div>
										</div>
										<div class="top-cart-item">
											<div class="top-cart-item-image">
												<div class="fbox-icon">
                                                    <a href="#"><i class="uil-setting i-alt"></i></a>
                                                </div>
											</div>
											<div class="top-cart-item-desc">
												<div class="top-cart-item-desc-title">
													<a href="#">Go to Settings</a>
													<!-- <span class="top-cart-item-price d-block">$24.99</span> -->
												</div>
												<!-- <div class="top-cart-item-quantity">x 3</div> -->
											</div>
										</div>
									</div>
									<div class="top-cart-action">
										<!-- <span class="top-checkout-price">$114.95</span> -->
										<a href="{% url "logout" %}" class="button button-3d button-red button-small m-0" id="log-out">Log Out</a>
									</div>
								</div>
							</div><!-- #top-cart end -->
                                    <!------- messages ------->
                                </div>
								
					        </div>
                  
								<div class="top-cart-content">
									<div class="top-cart-title">
										<h4>Account</h4>
                                        <span >
                                            <h3>{{ user.username }}</h3>
                                        </span>
									</div>
									<div class="top-cart-items">
										<div class="top-cart-item">
											<div class="top-cart-item-image">
												<div class="fbox-icon">
                                                    <a href="#"><i class="bi-person-fill-gear i-alt"></i></a>
                                                </div>
											</div>
											<div class="top-cart-item-desc">
												<div class="top-cart-item-desc-title">
													<a href="#">Go to Profile</a>
													<!-- <span class="top-cart-item-price d-block">$19.99</span> -->
												</div>
												<!-- <div class="top-cart-item-quantity">x 2</div> -->
											</div>
										</div>
										<div class="top-cart-item">
											<div class="top-cart-item-image">
												<div class="fbox-icon">
                                                    <a href="#"><i class="uil-setting i-alt"></i></a>
                                                </div>
											</div>
											<div class="top-cart-item-desc">
												<div class="top-cart-item-desc-title">
													<a href="#">Go to Settings</a>
													<!-- <span class="top-cart-item-price d-block">$24.99</span> -->
												</div>
												<!-- <div class="top-cart-item-quantity">x 3</div> -->
											</div>
										</div>
									</div>
									<div class="top-cart-action">
										<!-- <span class="top-checkout-price">$114.95</span> -->
										<a href="{% url "logout" %}" class="button button-3d button-red button-small m-0" id="log-out">Log Out</a>
									</div>
								</div>
							</div><!-- #top-cart end -->

						</div>

						<!-- <div class="primary-menu-trigger">
							<button class="cnvs-hamburger" type="button" title="Open Mobile Menu">
								<span class="cnvs-hamburger-box"><span class="cnvs-hamburger-inner"></span></span>
							</button>
						</div> -->

						<!-- Primary Navigation
						============================================= -->
						<nav class="primary-menu">

							<ul class="menu-container">
								<li class="menu-item">
									<!-- <a class="menu-link" href="index.html"><div>Home</div></a> -->
									<ul class="sub-menu-container">
										<li class="menu-item">
											<a class="menu-link" href="niche-demos.html"><div>Messages</div></a>
										</li>
									
										<li class="menu-item">
											<a class="menu-link" href="index-corporate.html"><div>Friends</div></a>
											<ul class="sub-menu-container">
                                                {% for friend in friends %}
												<li class="menu-item">
													<a class="menu-link" class="friend-li" friend-id="user_{{ friend.id }}" id="{{ friend.username }}">{{ friend.username}}</a>
												</li>
                                                {% endfor %}
											
											</ul>
										</li>
										
									</ul>
								</li>
								
							</ul>

						</nav><!-- #primary-menu end -->

						<!-- <form class="top-search-form" action="search.html" method="get">
							<input type="text" name="q" class="form-control" value="" placeholder="Type &amp; Hit Enter.." autocomplete="off">
						</form> -->

					</div>
				</div>
			</div>
			<div class="header-wrap-clone"></div>
		</header><!-- #header end -->
        <!-- <a href="#" class="button button-xlarge button-rounded side-panel-trigger mb-5">Open Side Panel</a> -->
        
	<div id="container">
                
	<aside>
		<header>
			
				<input type="text" placeholder="search" onkeyup="myFunction()" id="myInput">
			
		</header>
		<ul id="friend-list">
			
            {% for friend in friends %}
			
			

				<form name="friend-form" method="post">
				{% csrf_token %}
					<input name="friend" value="{{friend.id}}" type="hidden">
					
					<li chat-id="{% for conversation in conversations %}{% if conversation.first_person == friend or conversation.second_person == friend %}chat_{{ conversation.id }} {% endif %}{% endfor %}" name="friendbox"class="friend-li" friend-id="user_{{ friend.id }}" id="{{ friend.username }}" style="cursor: pointer">
						<img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1940306/chat_avatar_01.jpg" alt="">
						<div>
							<h2 style="font-weight: bold;">{{friend.username}} </h2>
							<h3 >
								<span class="status orange"></span>
								<span class="status_text" style="color: white"></span>
							</h3>
							
							
						</div>
					</li>
				</form>
			{% endfor %}		
		</ul>
	</aside>
	
	<main>
	{% for conversation in conversations %}
	<div class="messages-wrapper {% if conversationId == conversation.id %}is_active{% else %}hide{% endif %}" chat-id="chat_{{ conversation.id }}" id="chat_{{ conversation.id }}" other-user-id="
	{% if conversation.first_person == user %}
		{{ conversation.second_person.id }}
	{% else %}
		{{ conversation.first_person.id }}
	{% endif %}
	">
		<header>
			<img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1940306/chat_avatar_01.jpg" alt="">
			<div>
				{% if conversation.first_person == user %}
					<h2>Chat with {{ conversation.second_person.username }}</h2>
				{% else %}
					<h2>Chat with {{ conversation.first_person.username }}</h2>
				{% endif %}
				<h3>{{ conversation.chatmessage_conversation.all.count }} messages</h3>
				
			</div>
			<img src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1940306/ico_star.png" alt="">
		</header>
		{% load extra_filters %}
		<ul id="chat" class="msg_card_body ">
			{% for chat in conversation.chatmessage_conversation.all %}
				{% if chat.user == user %}
					
				<li class="me">
					<div class="entete">
						<h3>Me</h3>
						<h2>{{ chat.timestamp|date:"d D" }}, {{ chat.timestamp|time:"H:i" }}</h2>
						<span class="status blue"></span>
					</div>
					<div class="triangle"></div>
					<div class="message">
						
						{% if chat.message|slice:"0:11" != '(\'&(_FILE_)' %}
							{{ chat.message }}
						{% else %}
					
						{{ chat.message|filename|get_link}}
							{% if chat.message|filename|extension == 'png'  or chat.message|filename|extension == 'jpeg' or chat.message|filename|extension == 'jpg'%}
							<img style="width: 100%;height: 100%; " src="{{chat.message|get_link}}">
							{% endif %}
						{{ chat.message|filename}}
						<a href={{chat.message|get_link}} target="_blank" download={{chat.message|filename}}>
							
							<i class="fa fa-download "style="text-shadow: 0 0 5px #FFFFFF;"></i>
  							
						</a>
						
						{% endif %}
					</div>
				</li>
				{% else %}
				<li class="you">
					<div class="entete">
						<span class="status green"></span>
						<h2>{{ conversation.first_person.username }}</h2>
						<h3>{{ chat.timestamp|date:"d D" }}, {{ chat.timestamp|time:"H:i" }}</h3>
					</div>
					<div class="triangle"></div>
					<div class="message">
						{% if chat.message|slice:"0:11" != '(\'&(_FILE_)' %}
							{{ chat.message }}
						{% else %}
					
						{{ chat.message|filename|get_link}}
							{% if chat.message|filename|extension == 'png'  or chat.message|filename|extension == 'jpeg' or chat.message|filename|extension == 'jpg'%}
							<img style="width: 100%;height: 100%; " src="{{chat.message|get_link}}">
							{% endif %}
						{{ chat.message|filename}}
						<a href={{chat.message|get_link}} target="_blank" download={{chat.message|filename}}>
							
							<i class="fa fa-download "style="text-shadow: 0 0 5px #FFFFFF;"></i>
  							
						</a>
						
						{% endif %}
					</div>
				</li>
				{% endif %}
			{% endfor %}
			
			
		</ul>
		
		</div>
		<div class=" type typing_status"></div>
		{% endfor %}
		<footer>
			<form id="send-message-form">
				<div class="input-group">
					<div class="input-group-append">
						<span class="input-group-text attach_btn"><i class="fas fa-paperclip" id="attach_button"></i></span>
					</div>
					<input type="text" name="" id="input-message" class="form-control type_msg" placeholder="Type your message...">
					<div class="input-group-append">
						<button class="btn btn-secondary" type="submit">
							<span class="input-group-text send_btn">
								<i class="fas fa-location-arrow"></i>
							</span>
						</button>
						<button class="btn btn-secondary" type="button" id="speech_to_text">
							<span class="input-group-text send_btn">
								<i class="fas fa-microphone" id="speech_text_icon"></i>
							</span>
						</button>
					</div>
				  
					
				</div>
			</form>
		</footer>
	</main>
	
		</div>
        <!-- ----------------------================================================ -->
		

		<script>
			function updateFriendList() {
                //comment
				$.ajax({
					url: '{% url "friends_online_status" %}',
					success: function(data) {
						var onlineFriends = data.online_users;
						$('#friend-list li').each(function() {

							var username = $(this).attr('id');
							if (onlineFriends.includes(username)) {
								$(this).find('.status').removeClass('orange').addClass('green');
								$(this).find('.status_text').removeClass('orange_color').addClass('green_color').text("online");
							} else {
								$(this).find('.status').removeClass('green').addClass('orange');
								$(this).find('.status_text').removeClass('green_color').addClass('orange_color').text("offline");
							}
						});
					},
					complete: function() {
						setTimeout(updateFriendList, 5000); // call this function again in 5 seconds
					}
				});
			}

			$(document).ready(function() {
				updateFriendList();
			});
		</script>
        <script src="{% static 'js/messages.js' %}"></script>
        <script src="{% static 'js/conversations.js' %}"></script>
        <script src="{% static 'external/js/functions.js' %}"></script>
		<script>
			
			window.onload=function () {
				var messages_wrapper = document.getElementsByClassName("messages-wrapper")[0];
				messages_wrapper.setAttribute( 'class', 'messages-wrapper is_active' );
				var friend_li = document.getElementsByClassName("friend-li")[0];
				friend_li.setAttribute( 'class', 'friend-li active' );
				var objDiv = document.getElementById("chat");
				objDiv.scrollTop = objDiv.scrollHeight;
				
			}
		</script>
		<script>
			function myFunction() {
				var input, filter, ul, li, a, i, txtValue;
				input = document.getElementById("myInput");
				filter = input.value.toUpperCase();
				ul = document.getElementById("friend-list");
				li = ul.getElementsByTagName("li");
				for (i = 0; i < li.length; i++) {

					a = li[i].getElementsByTagName("h2")[0];
					
					txtValue = a.textContent || a.innerText;
					if (txtValue.toUpperCase().indexOf(filter) > -1) {
						li[i].style.display = "";
					} else {
						li[i].style.display = "none";
					}
				}
			}
			</script>
			
	</body>
</html>
