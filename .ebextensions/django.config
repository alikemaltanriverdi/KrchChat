packages:
  yum:
    git: []
    mod_wsgi: []

container_commands:
  00_wait_for_network:
    command: "echo 'Waiting for network to be available...'; while ! ping -c1 google.com &>/dev/null; do sleep 1; done"
  01_django_install:
    command: "yum update -y && yum install -y python-devel postgresql-devel && amazon-linux-extras enable postgresql14 -y"
  02_install:
    command: "source /var/app/venv/*/bin/activate && pip install psycopg2 && pip install -r /var/app/current/requirements.txt"
  03_collectstatic:
    command: "source /var/app/venv/*/bin/activate && python manage.py collectstatic --noinput"
  04_install_daphne:
    command: "source /var/app/venv/*/bin/activate && pip install daphne"
    leader_only: true
  05_start_daphne:
    command: "nohup daphne -b 0.0.0.0 -p 8001 myproject.asgi:application &> /dev/null &"

option_settings:
  aws:elasticbeanstalk:application:environment:
    DJANGO_SETTINGS_MODULE: KrchChat.settings
  aws:elasticbeanstalk:environment:proxy:staticfiles:
    /static: KrchChat/static
    /socket/: ws://localhost:8001/socket/
  aws:elasticbeanstalk:container:python:
    WSGIPath: KrchChat.wsgi:application

files:
  "/etc/httpd/conf.d/daphne.conf":
    mode: "000644"
    owner: root
    group: root
    content: |
      WSGIDaemonProcess daphne processes=2 threads=12 python-path=/var/app/current:/var/app/venv/*/lib/python3.8/site-packages
      WSGIProcessGroup daphne
      WSGIScriptAlias /socket /var/app/current/myproject/wsgi.py
      <Directory /var/app/current/KrchChat>
          <Files wsgi.py>
              Require all granted
          </Files>
      </Directory>
      ProxyPass /socket/ ws://127.0.0.1:8001/socket/
      ProxyPassReverse /socket/ ws://127.0.0.1:8001/socket/